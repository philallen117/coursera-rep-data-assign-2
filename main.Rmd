---
title: "Which weather events are the most harmful?"
author: "Phil Allen"
date: "22 January 2015"
output: html_document
---


## Synopsis: 

Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?


## Data Processing 

which describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.

```{r, cache=TRUE}
csvPath <- "data/StormData.csv"
bz2Path <- paste0(csvPath,".bz2")
if (!file.exists("data")) {
	dir.create("data")
}
if (!file.exists(bz2Path)) {
    download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", destfile = bz2Path)
}
if (!file.exists(csvPath)) {
	library("R.utils")
	bunzip2(filename = bz2Path, destname = csvPath, remove = FALSE)
}
StormData <- read.csv("data/StormData.csv", stringsAsFactors = FALSE)
StormData$BGN_DATE <- strptime(StormData$BGN_DATE,"%m/%d/%Y", tz = "UTC")
StormData$END_DATE <- strptime(StormData$END_DATE,"%m/%d/%Y", tz = "UTC")
StormData$EVTYPE <- as.factor(StormData$EVTYPE)
```

Pick a decade

```{r}
library(lubridate)
StormData$year <- year(StormData$BGN_DATE)
StormData$count <- 1
names(StormData) <- c()
decade <- StormData[StormData$year > 1990 & StormData$year <= 2000,]
chosen <- aggregate(cbind(FATALITIES, INJURIES, PROPDMG, CROPDMG) ~ EVTYPE, 
					data = decade,
					FUN = sum)
# head(chosen[order(-chosen$INJURIES),])
# head(chosen[order(-chosen$PROPDMG),])
# head(chosen[order(-chosen$CROPDMG),])

```

```{r}
kable(head(chosen[order(-chosen$FATALITIES),]))

```


Is there any strong correlation between fatalities and property damage?
```{r}
library(ggplot2)
p <- ggplot(data = decade, aes(log(1 + FATALITIES), log(1 + PROPDMG)))
p + geom_point()
```
There's a range of property damage for no or low levels of fatalities.
Where there are fatalites, there is some correlation between fatalities 
and the value of property damage.

Question "most damaging" could be interpreted several ways: 
does the most total damage regardless of frequency (sum)
typically does the most damage, when it happens (mean, median)
or causes the most extreme damage, when it happens (some high percentile)
Decided to go with the middle of those, and to use median.

```{r}
health.outcomes <- "cbind(FATALITIES, INJURIES)"
money.outcomes <- "cbind(PROPDMG, CROPDMG)"
# outcomes.time <- as.formula(paste0(outcomes," ~ year(BGN_DATE)"))
# sums.time <- aggregate(outcomes.time, data = try2, FUN = sum)
health.outcomes.type <- as.formula(paste0(outcomes," ~ EVTYPE"))
tiles.type <- aggregate(FATALITIES ~ EVTYPE, data = try2, FUN = quantile, probs = (c(0.9, 0.99, 0.999))) # didn't work - try dplyr
# Try to plot several aes on same plot for different quant points with factor on x axis
# COnsider logs

p <- qplot(decade)

```

```{r}

```


## Results



## Exploration of the source data

```{r}
sort(names(StormData))
```




Evidence of very skew distribution in some key variables.

```{r}
summary(StormData$FATALITIES)
quantile(StormData$FATALITIES, c(0.9, 0.99, 0.999, 0.9999))
summary(StormData$MAG)
quantile(StormData$MAG, c(0.9, 0.99, 0.999, 0.9999))
```

## Limitations

The data seems to relate only to the lower 48 states.

