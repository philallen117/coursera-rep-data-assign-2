---
title: "Which weather events are the most harmful?"
author: "Phil Allen"
date: "22 January 2015"
output: html_document
---


## Synopsis: 

Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?


## Data Processing 

which describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.

```{r, cache=TRUE}
csvPath <- "data/StormData.csv"
bz2Path <- paste0(csvPath,".bz2")
if (!file.exists("data")) {
	dir.create("data")
}
if (!file.exists(bz2Path)) {
    download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", destfile = bz2Path)
}
if (!file.exists(csvPath)) {
	library("R.utils")
	bunzip2(filename = bz2Path, destname = csvPath, remove = FALSE)
}
StormData <- read.csv("data/StormData.csv", stringsAsFactors = FALSE)
StormData$BGN_DATE <- strptime(StormData$BGN_DATE,"%m/%d/%Y", tz = "UTC")
StormData$END_DATE <- strptime(StormData$END_DATE,"%m/%d/%Y", tz = "UTC")
StormData$EVTYPE <- as.factor(StormData$EVTYPE)
```

Pick a decade where numbers of reported events are relatively stable.

```{r, cache=TRUE}
library(lubridate)
decade <- StormData[year(StormData$BGN_DATE) > 1990
					& year(StormData$BGN_DATE) <= 2000,]
decade.fat <- aggregate(FATALITIES ~ EVTYPE, data = decade, FUN = sum)
decade.inj <- aggregate(INJURIES ~ EVTYPE, data = decade, FUN = sum)
decade.damage <- aggregate(PROPDMG + CROPDMG ~ EVTYPE, data = decade, FUN = sum)
```

For direct human harm, intially consider fatalities.

```{r, results='asis'}
library(knitr)
kable(head(decade.fat[order(-decade.fat$FATALITIES),], n = 5),
	  row.names = FALSE,
	  col.names = c("Type of event", "Number of fatalities"),
	  caption = "Top five event types by number of fatalities")
```

The ordering for injuries is somewhat different.

```{r, results='asis'}
kable(head(decade.inj[order(-decade.inj$INJURIES),], n = 5),
	  row.names = FALSE,
	  col.names = c("Type of event", "Number of injuries"),
	  caption = "Top five event types by number of injuries")
```

So rank depends on the relative weight of these outcomes.
Many of the injuries will be life-changing,
but more will heal in a few weeks.
Arbitrarily choosing a ratio 100:1, the ranks are as follows.

```{r, results='asis'}
decade.human.harm <- merge(decade.fat, decade.inj)
decade.human.harm$weighted =
	100 * decade.human.harm$FATALITIES + decade.human.harm$INJURIES
kable(head(decade.inj[order(-decade.inj$INJURIES),], n = 5),
	  row.names = FALSE,
	  col.names = c("Type of event", "Weighted human harm"),
	  caption = "Top five event types by weighted human harm")
```



```{r, results='asis'}
kable(head(decade.damage[order(-decade.damage$PROPDMG),], n = 5),
	  row.names = FALSE,
	  col.names = c("Type of event", "Value of property and crop damage (K$)"),
	  caption = "Top five event types by value of damage")
```


```{r, results='asis'}
library(knitr)
kable(head(decade.fat[order(-decade.fat$FATALITIES),], n = 5),
	  row.names = FALSE,
	  col.names = c("Type of event", "Value of crop damage"),
	  caption = "Top five event types by value of crop damage")

```


Is there any strong correlation between fatalities and property damage?
```{r}
# library(ggplot2)
# p <- ggplot(data = decade, aes(log(1 + FATALITIES), log(1 + PROPDMG)))
# p + geom_point()
```

There's a range of property damage for no or low levels of fatalities.
Where there are fatalites, there is some correlation between fatalities 
and the value of property damage.

Question "most damaging" could be interpreted several ways: 
does the most total damage regardless of frequency (sum)
typically does the most damage, when it happens (mean, median)
or causes the most extreme damage, when it happens (some high percentile)
Decided to go with the middle of those, and to use median.


## Results



## Exploration of the source data


Evidence of very skew distribution in some key variables.

```{r}
summary(StormData$FATALITIES)
quantile(StormData$FATALITIES, c(0.9, 0.99, 0.999, 0.9999))
summary(StormData$PROPDMG)
quantile(StormData$PROPDMG, c(0.9, 0.99, 0.999, 0.9999))
```

## Limitations

The data seems to relate only to the lower 48 states.

